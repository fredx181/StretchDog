#!/bin/bash

export TEXTDOMAIN=frisbee
export OUTPUT_CHARSET=UTF-8
. gettext.sh

ps aux | grep -q 'wvdial isp[12]' \
 || rm -f /tmp/.network_tray-use_analog_dialup_icons 2>/dev/null #130505
[ -d /tmp/.network_tray ] \
 && touch /tmp/.network_tray/use-digital-dialup-icons \
 && ( ps aux | grep -q 'wvdial isp[12]' || rm -f /tmp/.network_tray/use_analog_dialup_icons 2>/dev/null ) #140209

. /etc/ppp/gprs.conf

if ! echo "$GPRSDEV" | grep -q '^/'; then
	Xdialog  --title "Frisbee"  --msgbox "$(gettext 'Cannot connect - No modem interface (/dev/...) specified.')" 0 0
	exit 1
fi

if [ -z "$GPRSAPN" ];then
	Xdialog  --title "Frisbee"  --msgbox "$(gettext 'Cannot connect - No Access Point Name (APN) specified.')" 0 0
	exit 1
fi

if [ -z "$GPRSNBR" ];then
	Xdialog  --title "Frisbee"  --msgbox "$(gettext 'Cannot connect - No Access Number specified (e.g., #99*).')" 0 0
	exit 1
fi

if [ -f /var/run/ppp-gprs.pid ];then
	ACTIVEDEV="$(ps | grep "^ *$(cat /var/run/ppp-gprs.pid)" | grep 'pppd' | grep -v 'grep' | grep -o '/dev/[a-z][^ ]*')"
	if [ "$ACTIVEDEV" != "" ];then
		Xdialog  --title "Frisbee"  --msgbox "`eval_gettext \"Cannot connect with mobile device \\\$GPRSDEV.\nMobile device $ACTIVEDEV is currently connected.\"`" 0 0
		exit 1
	fi
fi

SAVEVAL="'AT+CGDCONT=1,\"IP\",\"$GPRSAPN\"'"
[ "$SAVEVAL" != "$(cat /etc/ppp/chatscripts/gprs-cgdcont_command 2>/dev/null)" ] && echo "$SAVEVAL" > /etc/ppp/chatscripts/gprs-cgdcont_command

SAVEVAL="'ATD$GPRSNBR'"
[ "$SAVEVAL" != "$(cat /etc/ppp/chatscripts/gprs-dial_command 2>/dev/null)" ] && echo "$SAVEVAL" > /etc/ppp/chatscripts/gprs-dial_command

[ "$GPRSPIN" ] \
 && SAVEVAL="'AT+CPIN=\"$GPRSPIN\"'" || SAVEVAL="AT"
[ "$SAVEVAL" != "$(cat /etc/ppp/chatscripts/gprs-cpin_command 2>/dev/null)" ] \
 && echo "$SAVEVAL" > /etc/ppp/chatscripts/gprs-cpin_command

if [ "$GPRSUSER" ];then
	[ "$GPRSPAPONLY" = "true" ] && PAPVAL="\nrequire-pap" || PAPVAL=""
	SAVEVAL="$(echo -e "auth\nuser $GPRSUSER$PAPVAL")"
	[ "$SAVEVAL" != "$(cat /etc/ppp/peers/gprs-auth 2>/dev/null)" ] \
	 && echo "$SAVEVAL" > /etc/ppp/peers/gprs-auth
else
	[ "$(echo "noauth")" != "$(cat /etc/ppp/peers/gprs-auth 2>/dev/null)" ] \
	 && echo "noauth" > /etc/ppp/peers/gprs-auth
fi

MAX_SECONDS_TIMEOUT=30
for ((RETRY=0; RETRY < ${MAX_SECONDS_TIMEOUT}; RETRY++));do
	if [ -c $GPRSDEV ]; then
		[ $RETRY -gt 0 ] \
		 && logger "`eval_gettext \"\\\$0: Waited for device \\\$GPRSDEV for \\\$RETRY seconds\"`"
		break
	else
		sleep 1
	fi
done
if [ ! -c $GPRSDEV ]; then
	logger "`eval_gettext \"\\\$0: ERROR timeout (\\\$MAX_SECONDS_TIMEOUT seconds) waiting for required device \\\$GPRSDEV\"`"
	exit 1
fi

# Start PPP daemon...
# Let pppd detach from its controlling terminal once it has successfully
# established the ppp connection (to the point where the first network
# control protocol, usually the IP control protocol, has come up): updetach
# For sanity, keep a lock on the serial line: lock
/usr/sbin/pppd $GPRSDEV \
 file /etc/ppp/options.gprs \
 call gprs-auth \
 connect "/usr/sbin/chat -v -f /etc/ppp/chatscripts/gprs-connect-chat" \
 disconnect "/usr/sbin/chat -v -s -S -f /etc/ppp/chatscripts/gprs-disconnect-chat" \
 linkname gprs \
 updetach \
 lock \
 &> /tmp/.frisbee/gprs.log
RC=$?
logger "frisbee-gprs-connect: `eval_gettext \"pppd exit status for \\\$GPRSDEV is \\\$RC\"`"

if [ $RC -eq 1 ];then
	if [ -f /var/run/ppp-gprs.pid ];then
		Xdialog --center --wmclass "frisbee" --backtitle "$(gettext 'NOTICE: If the log shows a failure to connect, please click left button.')" --title "$(gettext 'Frisbee: GPRS connection log')" --ok-label "$(gettext 'DISCONNECT or stop trying')" --cancel-label "$(gettext 'CLOSE window but stay online')" --fixed-font --tailbox /tmp/.frisbee/gprs.log 20 82
		if [ $? -eq 0 ];then
			frisbee-gprs-disconnect
			echo -e "\n------------------------------------------------------\n" >> /tmp/.frisbee/gprs.log
		fi
	else
		Xdialog --center --wmclass "frisbee" --backtitle "$(gettext 'The attempt to connect was unsuccessful:')" --title "$(gettext 'Frisbee: GPRS connection log')" --no-cancel --fixed-font --tailbox /tmp/.frisbee/gprs.log 20 82
	fi
else
	Xdialog  --title "Frisbee"  --msgbox "`eval_gettext \"Mobile device \\\$GPRSDEV failed to connect, with exit status \\\$RC\"`" 0 0
fi
echo "frisbee-gprs-connect - CONNECTEDDEV: $CONNECTEDDEV  " >> /tmp/debug.log  #DEBUG
