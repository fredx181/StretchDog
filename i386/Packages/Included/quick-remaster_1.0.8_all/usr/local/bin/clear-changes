#!/bin/bash

# clear save content at reboot, works only with porteus-boot
# idea from rufwoof, as also implemented in quick-remaster script
# depends on small edit in linuxrc (from initrd1.xz)

# check if booted with porteus boot
echo "Note that this script works only when porteus boot style is used"
echo "Checking if porteus boot style is used..."
	if [ ! -f /mnt/live/tmp/modules ]; then
	echo "Porteus boot style is not being used, cannot continue, exiting now..."
	sleep 2
	exit 0
	fi
echo ..........
echo "Porteus boot style is being used, let's continue..."
echo
echo "This script will clear the stored save content at next reboot"
echo "Could be handy sometimes if you want to start 'fresh',"
echo "without having to remove the content of save file/folder manually"

 # fredx181, check if linuxrc contains clear-changes-on-reboot
    if grep -iq clear-changes-on-reboot /mnt/live/linuxrc; then 
if [ -f /mnt/live/tmp/changes-exit ]; then
CHANGES=$(cat /proc/cmdline | grep -o "changes=.*" |sed 's| .*||' |sed 's|changes=||' | awk 'BEGIN{FS="EXIT:"} {print $2}')
else
CHANGES=$(cat /proc/cmdline | grep -o "changes=.*" |sed 's| .*||' |sed 's|changes=||')
fi
# check if changes=... is being used at all, if not, exit
	if [[ $CHANGES != "" ]]; then
echo -e "\e[0;30mPress [Enter] (or y or Y) for 'yes'...\033[0m"	
read -n 1 -p "Do you want to have current save storage emptied at reboot? (Y/n)?" choice
echo
case "$choice" in 
  y|Y|"")
echo -e "\e[0;32mOk, changes content from $CHANGES will be emptied at reboot\033[0m"
if [ -f /mnt/live/tmp/changes-exit ]; then touch /mnt/live/memory/images/changes-exit/clear-changes-on-reboot; else touch /mnt/live/memory/changes/clear-changes-on-reboot; fi
echo
read -s -n 1 -p "Press any key to close . . ."
echo
exit 0
;;
  n|N)
echo -e "\e[0;30mChanges content will NOT be emptied at reboot\033[0m"
read -s -n 1 -p "Press any key to close . . ."
echo
exit 0
;;
*)
echo -e "\e[0;31mNot a valid choice, exiting....\033[0m"
sleep 4
exit 0
;;
esac
	else
echo "Not booted with changes= parameter, nothing to do, exiting..."
sleep 4
exit
	fi
    else
echo "The initrd1.xz in use doesn't support clear-changes-on-reboot, exiting..."
sleep 4
    fi
